#!/bin/sh
#
# s p d i
#
# This test generates a 5x5 specular and diffuse grid of sphere primitives.
# The resultings image that is raytraced gets compared against a reference
# image.
#
###
# Source function library
. `dirname $0`/library

NAME=SpecularDiffuse


start ( ) {

BIN=$BRLCAD_ROOT/bin
export BIN

rm -f spdi.g spdi.rt spdi.log spdi.pix

$BIN/mged -c spdi.g << EOF


set glob_compat_mode 0

in half.s half 0 0 1 -1
r half.r u half.s
mater half.r plastic 76 158 113 0
g all.g half.r

set radius 256
foreach p {1 2 3 4 5} { 

  set sh [expr \$p \* 4]
  set y  [expr [expr \$p - 3] \* 640]

  foreach v {1 2 3 4 5} {
    set sp [expr \$v \* 0.2]
    set di [expr 1.0 - \$sp]
    set x  [expr [expr \$v - 3] \* 640]

    in sph_\${sp}_\${sh}.s sph \$x \$y \$radius \$radius
    r  sph_\${sp}_\${sh}.r u sph_\${sp}_\${sh}.s
    mater sph_\${sp}_\${sh}.r "plastic {sp \$sp di \$di sh \$sh}" 100 200 200 0

    g all.g sph_\${sp}_\${sh}.r
  }
}

set glob_compat_mode 1

in light1.s ell -464 339 2213 0 100 0 0 0 100 100 0 0
r light1.r u light1.s
mater light1.r "light {invisible 1 angle 180 infinite 1}" 255 255 255 0
g all.g light1.r

Z
e all.g
press top
size 3200
saveview spdi.rt
q
EOF

mv spdi.rt spdi.orig
sed "s,^rt,$BIN/rt," < spdi.orig > spdi.rt
rm spdi.orig
chmod 775 spdi.rt
echo "rendering..."
./spdi.rt

}


status ( ) {
    if [ ! -f $REGRESS_DIR/spdi.rt ] || [ ! -f $REGRESS_DIR/spdi.g ] ; then
        warn "mged failed"
        return 1
    fi
    log "spdi OK"
    return 0
}

stop ( ) {
    log "stopping this damn bitch"
}

regress $1

exit $?
